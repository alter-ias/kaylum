<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAYLUM - Canto de la Tierra</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0F121B"/>
    
    <link rel="icon" type="image/png" href="assets/img/labplay/logokaylum.png">
    <link rel="apple-touch-icon" href="assets/img/labplay/logokaylum.png">
    
    <script>
        (function() {
            const savedColor = localStorage.getItem('kaylum_textColor');
            if (savedColor) {
                document.documentElement.style.setProperty('--text-color', savedColor);
            }
        })();
    </script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>
    <style>
        :root {
            --background-color: #0F121B;
            --text-color: #FFFFFF;
            --secondary-text-color: #b3b3b3;
            --player-border-color: rgba(255, 255, 255, 0.4);
            --text-shadow: 0px 2px 5px rgba(0, 0, 0, 0.7);
            --downloaded-color: #32a852; 
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { color: var(--text-color); font-family: 'Montserrat', sans-serif; background-color: var(--background-color); overflow-x: hidden; }
        #background-video { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; object-fit: cover; filter: brightness(0.5); transition: opacity 0.5s ease-in-out; }
        .container { width: 90%; max-width: 1200px; margin: 0 auto; position: relative; z-index: 2; }
        .page-wrapper { display: flex; flex-direction: column; min-height: 100vh; }
        .main-header { padding: 30px 0; text-align: center; }
        .logo a { display: flex; align-items: center; gap: 10px; text-decoration: none; flex-direction: column; }
        .logo img { height: 40px; width: auto; }
        .logo .logo-text { font-size: 1.5rem; font-weight: 700; letter-spacing: 2px; text-shadow: var(--text-shadow); color: var(--text-color); }
        .logo .subtitle { font-size: 0.9rem; color: var(--secondary-text-color); font-weight: 400; margin-top: 5px; letter-spacing: 0.5px; font-style: italic; max-width: 400px; margin-left: auto; margin-right: auto; line-height: 1.4; }
        main { flex-grow: 1; display: flex; align-items: center; justify-content: center; padding: 20px 0; }
        .music-app { width: 100%; max-width: 480px; }
        .category-tabs { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 25px; }
        .category-tabs button { background-color: transparent; border: 1px solid var(--player-border-color); color: var(--text-color); font-family: 'Montserrat', sans-serif; font-weight: 500; font-size: 0.85rem; padding: 6px 14px; border-radius: 20px; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 6px; }
        .category-tabs button:hover { background-color: rgba(255, 255, 255, 0.1); border-color: var(--text-color); }
        .category-tabs button.active { background-color: rgba(255, 255, 255, 0.2); border-color: var(--text-color); color: var(--text-color); font-weight: 700; }
        .search-container { margin-bottom: 25px; }
        #search-input { width: 100%; padding: 12px 15px; background-color: rgba(255, 255, 255, 0.1); border: 1px solid var(--player-border-color); border-radius: 25px; color: var(--text-color); font-family: 'Montserrat', sans-serif; font-size: 0.9rem; outline: none; transition: border-color 0.3s ease, background-color 0.3s ease; }
        #search-input:focus { border-color: var(--text-color); }
        .player-wrapper { padding: 30px; border: 2px solid var(--player-border-color); border-radius: 15px; text-align: center; background-color: rgba(15, 18, 27, 0.3); backdrop-filter: blur(8px); }
        .album-art-container { width: 100%; max-width: 250px; margin: 0 auto 25px; }
        #album-art { width: 100%; aspect-ratio: 1 / 1; object-fit: cover; border-radius: 10px; box-shadow: 0 5px 25px rgba(0,0,0,0.5); }
        .track-info { display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 8px; }
        .track-info h2 { font-size: 1.6rem; font-weight: 700; text-shadow: var(--text-shadow); }
        #add-to-favorites-btn { background: none; border: none; color: var(--secondary-text-color); font-size: 1.5rem; cursor: pointer; transition: color 0.3s ease, transform 0.2s ease; padding: 0; line-height: 1; }
        #add-to-favorites-btn:hover { color: var(--text-color); transform: scale(1.1); }
        #add-to-favorites-btn.is-favorite { color: var(--text-color); opacity: 1; }
        #song-artist { cursor: pointer; transition: color 0.3s ease; display: inline-block; padding: 5px 10px; border-radius: 15px; margin-top: -15px; font-size: 1rem; color: var(--secondary-text-color); margin-bottom: 25px; text-shadow: var(--text-shadow); }
        #song-artist:hover { color: var(--text-color); background-color: rgba(255,255,255,0.1); }
        .player-controls { display: flex; justify-content: center; align-items: center; gap: 30px; margin-bottom: 25px; }
        .player-controls button { background: none; border: none; color: var(--secondary-text-color); font-size: 2rem; cursor: pointer; transition: color 0.3s ease, transform 0.2s ease; }
        .player-controls button#share-btn { font-size: 1.5rem; }
        .player-controls button:hover { color: var(--text-color); transform: scale(1.1); }
        .player-controls button.active { color: var(--text-color); }
        #audio-container { width: 100%; margin-top: -10px; margin-bottom: 20px; }
        #audio-player { width: 100%; }
        #song-info-toggle-btn { display: none; width: 100%; background-color: transparent; border: 1px solid var(--player-border-color); color: var(--text-color); font-family: 'Montserrat', sans-serif; font-weight: 500; padding: 8px 18px; border-radius: 20px; cursor: pointer; transition: all 0.3s ease; margin-bottom: 15px; }
        #song-info-toggle-btn:hover { background-color: rgba(255, 255, 255, 0.1); border-color: var(--text-color); }
        #song-information { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out, padding 0.5s ease-out; padding: 0; border-top: none; text-align: left; font-size: 0.95rem; line-height: 1.6; color: var(--secondary-text-color); text-shadow: var(--text-shadow); white-space: pre-wrap; }
        #song-information.is-open { max-height: 250px; overflow-y: auto; padding: 20px 10px 20px 0; border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .playlist-view { margin-top: 20px; min-height: 295px; border-radius: 10px; padding-right: 5px; }
        .playlist-view ol { list-style: none; padding: 0; margin: 0; }
        .playlist-view li { display: flex; align-items: center; gap: 15px; padding: 12px 15px; border-radius: 8px; cursor: pointer; transition: background-color 0.3s ease; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .playlist-view li:hover { background-color: rgba(255,255,255,0.1); }
        .playlist-view li .track-details { flex-grow: 1; }
        .playlist-view li .title { font-weight: 500; }
        .playlist-view li .artist { font-size: 0.85rem; color: var(--secondary-text-color); }
        .playlist-view li .icon { font-size: 1.2rem; color: transparent; }
        .playlist-view li.playing { background-color: rgba(255, 255, 255, 0.1); }
        .playlist-view li.playing .icon { color: var(--text-color); }
        .playlist-view li.playing .title { color: var(--text-color); font-weight: 700; }
        .pagination-controls { display: flex; justify-content: center; align-items: center; gap: 16px; margin-top: 20px; padding-bottom: 10px; }
        .pagination-controls button { background: none; border: none; color: var(--text-color); font-weight: 500; font-size: 1rem; cursor: pointer; transition: opacity 0.3s ease; opacity: 0.6; padding: 5px; }
        .pagination-controls button:hover:not(:disabled) { opacity: 1; }
        .pagination-controls button.active { opacity: 1; font-weight: 700; cursor: default; }
        .pagination-controls button:disabled { opacity: 0.3; cursor: not-allowed; }
        .adventure-mode-container { text-align: center; padding: 30px 0 10px; }
        #adventure-mode-btn { background-color: transparent; border: 1px solid var(--player-border-color); color: var(--text-color); font-family: 'Montserrat', sans-serif; font-weight: 500; font-size: 0.85rem; padding: 6px 14px; border-radius: 20px; cursor: pointer; transition: all 0.3s ease; }
        #adventure-mode-btn:hover { background-color: rgba(255, 255, 255, 0.1); border-color: var(--text-color); }
        #adventure-mode-btn.active { background-color: rgba(255, 255, 255, 0.2); border-color: var(--text-color); color: var(--text-color); font-weight: 700; }
        .personalization-section { display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 15px; padding: 20px 0; margin-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.2); }
        .personalization-btn { background-color: transparent; border: 1px solid var(--player-border-color); color: var(--text-color); font-family: 'Montserrat', sans-serif; font-weight: 500; font-size: 0.85rem; padding: 6px 14px; border-radius: 20px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; }
        .personalization-btn:hover { background-color: rgba(255, 255, 255, 0.1); border-color: var(--text-color); }
        .personalization-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        #color-picker { opacity: 0; width: 0; height: 0; position: absolute; }
        .project-description { padding: 40px 0; text-align: center; }
        .description-wrapper { max-width: 700px; margin: 0 auto; background-color: rgba(15, 18, 27, 0.3); backdrop-filter: blur(8px); border: 1px solid var(--player-border-color); border-radius: 15px; }
        #about-toggle-btn { background-color: transparent; border: 1px solid var(--player-border-color); color: var(--text-color); font-family: 'Montserrat', sans-serif; font-weight: 500; border-radius: 20px; cursor: pointer; transition: all 0.3s ease; width: 100%; font-size: 1.2rem; padding: 10px 20px; }
        #about-toggle-btn:hover { background-color: rgba(255, 255, 255, 0.1); border-color: var(--text-color); }
        #about-content { max-height: 0; overflow: hidden; transition: max-height 0.7s ease-in-out; padding: 0 30px; text-align: center; }
        #about-content p { margin-bottom: 1.5em; text-align: justify; }
        #about-content p:last-child { margin-bottom: 0; }
        #about-content.is-open { max-height: 2000px; padding: 30px 30px 30px; }
        .flux-diagram { width: 100%; max-width: 500px; border-radius: 10px; margin: 25px auto; border: 1px solid var(--player-border-color); display: block; }
        .page-footer { padding: 20px 0 40px; text-align: center; }
        #add-to-home-btn { display: none; background-color: transparent; border: 1px solid var(--player-border-color); color: var(--text-color); font-family: 'Montserrat', sans-serif; font-weight: 500; font-size: 1rem; padding: 10px 20px; border-radius: 25px; cursor: pointer; transition: all 0.3s ease; align-items: center; gap: 10px; }
        #add-to-home-btn:hover { background-color: rgba(255, 255, 255, 0.1); border-color: var(--text-color); }
        .playlist-view li .download-btn {
            background: none;
            border: none;
            color: var(--secondary-text-color);
            font-size: 1.2rem;
            cursor: pointer;
            transition: color 0.3s ease, transform 0.2s ease;
            padding: 5px;
            margin-left: auto;
        }
        .playlist-view li .download-btn:hover:not(:disabled) {
            color: var(--text-color);
            transform: scale(1.1);
        }
        .playlist-view li .download-btn.downloaded { color: var(--downloaded-color); }
        .playlist-view li .download-btn:disabled { cursor: not-allowed; opacity: 0.8; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .spinner {
            display: inline-block;
            width: 1em;
            height: 1em;
            border: 2px solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spin .75s linear infinite;
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <video autoplay muted loop playsinline id="background-video"></video>
        <header class="main-header container">
            <div class="logo-container">
                <div class="logo">
                    <a href=""><img src="assets/img/logo03.png" alt="Kaylum Logo"><span class="logo-text">KAYLUM</span></a>
                    <p class="subtitle">Neologismo que fusiona la raíz maya K'ay (canto) y Lum (tierra), significando 'Canto de la Tierra'.</p>
                </div>
            </div>
        </header>
        <main class="container">
            <div class="music-app">
                <div class="category-tabs" id="category-tabs"></div>
                <div class="search-container">
                    <input type="search" id="search-input" placeholder="Buscar en toda la biblioteca...">
                </div>
                <div class="player-wrapper" id="player-wrapper">
                    <div class="album-art-container">
                        <img src="assets/img/labplay/default-cover.jpg" alt="Carátula del Álbum" id="album-art">
                    </div>
                    <div class="track-info">
                        <h2 id="song-title">Selecciona una canción</h2>
                        <button id="add-to-favorites-btn" title="Añadir a Favoritos"><i class="bi bi-heart"></i></button>
                    </div>
                    <p id="song-artist">para comenzar</p>
                    <div class="player-controls">
                        <button id="shuffle-btn" title="Aleatorio"><i class="bi bi-shuffle"></i></button>
                        <button id="prev-btn" title="Anterior"><i class="bi bi-skip-start-fill"></i></button>
                        <button id="repeat-btn" title="Repetir"><i class="bi bi-repeat"></i></button>
                        <button id="next-btn" title="Siguiente"><i class="bi bi-skip-end-fill"></i></button>
                        <button id="share-btn" title="Compartir"><i class="bi bi-share-fill"></i></button>
                    </div>
                    <div id="audio-container">
                        <audio id="audio-player" controls></audio>
                    </div>
                    <button id="song-info-toggle-btn">SOBRE ESTA ROLA</button>
                    <div id="song-information"></div>
                </div>
                <div class="playlist-view" id="playlist-view"></div>
                <div class="pagination-controls" id="pagination-controls"></div>
                <div class="adventure-mode-container">
                    <button id="adventure-mode-btn">MÁQUINA DEL TIEMPO</button>
                </div>
                <div class="personalization-section">
                    <button id="change-skin-btn" class="personalization-btn">
                        <i class="bi bi-easel"></i> Cambiar Skin
                    </button>
                    <button id="download-skins-btn" class="personalization-btn">
                        <i class="bi bi-cloud-download"></i> Guardar Skins
                    </button>
                    <label for="color-picker" id="color-picker-label" class="personalization-btn">
                        <i class="bi bi-palette-fill"></i> Color de Texto
                    </label>
                    <input type="color" id="color-picker" value="#FFFFFF">
                </div>
            </div>
        </main>
        <section class="project-description container">
            <div class="description-wrapper">
                <button id="about-toggle-btn">Acerca de este proyecto</button>
                <div id="about-content">
                    <p>
                        Daniel Ek, CEO de Spotify, ha liderado una inversión millonaria en Helsing, startup alemana especializada en drones de combate con inteligencia artificial. Este acto alimenta una infraestructura de dominación que afecta de manera desproporcionada al Sur Global.
                    </p>
                    <p>
                        Como respuesta, desde el Laboratorio de Arte Generativo impulsamos <strong>KAYLUM</strong>: una plataforma que ofrece a nuestra comunidad una alternativa para escuchar y compartir su música favorita sin suscripciones. El proyecto está potenciado por agentes automatizados que catalogan el acervo, haciendo posible que se actualice con solo subir canciones a un servidor, demostrando el poder de la automatización para liberar trabajo y no para precarizarlo.
                    </p>
                    <img src="assets/img/labplay/alterplayflux.png" alt="Diagrama de flujo del proyecto Kaylum" class="flux-diagram">
                    <p>
                        Este proyecto, como cada una de nuestras iniciativas, busca demostrar que la tecnología no es inherentemente nociva. Es una herramienta poderosa que, usada de forma colectiva, nos permite construir proyectos potentes que fortalecen la autonomía y confrontan directamente los planes de la élite tecnofeudal.
                    </p>
                    <p>
                        Mientras ell@s dicen Guerra, nosotr@s decimos Paz. Por eso, la primera selección de este reproductor se basa en música que se ha posicionado contra la industria bélica. Somos conscientes de que un proyecto así desafía las nociones de propiedad intelectual, por lo que aclaramos que <strong>no existe fin de lucro alguno</strong>. Nuestra intención es el intercambio libre de la cultura.
                    </p>
                    <p>
                        Nuestra ambición trasciende el simple intercambio; soñamos con que este espacio evolucione hacia un refugio para l@s artistas independientes que rechazan mantener los privilegios de una élite que abusa de su trabajo. Invitamos a l@s artistas, músic@s, podcaster@s y experimentador@s sonoros a alojar sus creaciones en este espacio, construido por tod@s y para tod@s.
                    </p>
                </div>
            </div>
        </section>
        <footer class="page-footer container">
            <button id="add-to-home-btn">
                <i class="bi bi-download"></i>
                Añadir a Pantalla de Inicio
            </button>
        </footer>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // 1. VARIABLES Y CONSTANTES
    const addToHomeBtn = document.getElementById('add-to-home-btn');
    const songTitleEl = document.getElementById('song-title');
    const songArtistEl = document.getElementById('song-artist');
    const albumArtEl = document.getElementById('album-art');
    const audioPlayer = document.getElementById('audio-player');
    const categoryTabsContainer = document.getElementById('category-tabs');
    const playlistViewContainer = document.getElementById('playlist-view');
    const songInformationEl = document.getElementById('song-information');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const searchInput = document.getElementById('search-input');
    const paginationControlsContainer = document.getElementById('pagination-controls');
    const shuffleBtn = document.getElementById('shuffle-btn');
    const aboutToggleBtn = document.getElementById('about-toggle-btn');
    const aboutContent = document.getElementById('about-content');
    const songInfoToggleBtn = document.getElementById('song-info-toggle-btn');
    const adventureModeBtn = document.getElementById('adventure-mode-btn');
    const backgroundVideo = document.getElementById('background-video');
    const changeSkinBtn = document.getElementById('change-skin-btn');
    const colorPicker = document.getElementById('color-picker');
    const repeatBtn = document.getElementById('repeat-btn');
    const shareBtn = document.getElementById('share-btn');
    const addToFavoritesBtn = document.getElementById('add-to-favorites-btn');
    const downloadSkinsBtn = document.getElementById('download-skins-btn');

    let deferredInstallPrompt = null;
    const cloudinaryBaseUrl = 'https://res.cloudinary.com/dy9cywux2/video/upload/';
    const googleSheetCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRxbKnkTFmkECMfd_cRKchEv2XGOHII6YlLj0M0ragfExCtRWB2S0qTIZYrrFCTk3sxxctY2dnVgUif/pub?output=csv';
    const skinsPath = 'assets/img/labplay/skins/';
    const defaultCover = 'assets/img/labplay/default-cover.jpg';
    const songsPerPage = 5;
    let playlistsData = {};
    let currentCategory = '';
    let currentPlaylist = [];
    let displayedPlaylist = []; 
    let allSongs = [];
    let currentSongIndex = -1;
    let fuse;
    let currentPage = 1;
    let isShuffleActive = false;
    let skins = [];
    let currentSkinIndex = 0;
    let isRepeatActive = false;
    let userFavorites = [];
    let downloadedSongs = new Set(); 

    // 2. DEFINICIÓN DE TODAS LAS FUNCIONES
    const shuffleArray = (array) => { let newArr = [...array]; for (let i = newArr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[newArr[i], newArr[j]] = [newArr[j], newArr[i]]; } return newArr; };
    const parseCsvRow = (row) => { const c = []; let d = ''; let e = !1; for (let f = 0; f < row.length; f++) { const g = row[f]; if ('"' === g) e && '"' === row[f + 1] ? (d += '"', f++) : e = !e; else if (',' === g && !e) c.push(d.trim()), d = ''; else d += g } c.push(d.trim()); return c.map(h => h.startsWith('"') && h.endsWith('"') ? h.slice(1, -1) : h) };
    function getDownloadedSongMetadata() { const metadata = localStorage.getItem('kaylum_downloaded_metadata'); return metadata ? JSON.parse(metadata) : {}; }
    function saveDownloadedSongMetadata(songObject) { const allMetadata = getDownloadedSongMetadata(); allMetadata[songObject.publicId] = songObject; localStorage.setItem('kaylum_downloaded_metadata', JSON.stringify(allMetadata));}

    // --- Funciones de Descarga ---
    function handleDownloadClick(button) {
        const songId = button.dataset.songId;
        const songUrl = button.dataset.songUrl;
        const songToDownload = allSongs.find(song => song.publicId === songId);
        if (!songToDownload || !navigator.serviceWorker.controller) return;
        updateDownloadButtonStatus(songId, 'downloading');
        saveDownloadedSongMetadata(songToDownload);
        navigator.serviceWorker.controller.postMessage({ action: 'DOWNLOAD_SONG', songId: songId, url: songUrl });
    }
    function updateDownloadButtonStatus(songId, status) {
        document.querySelectorAll(`.download-btn[data-song-id="${songId}"]`).forEach(button => {
            if (!button) return;
            button.disabled = false;
            button.classList.remove('downloaded');
            switch (status) {
                case 'downloading': button.innerHTML = '<span class="spinner"></span>'; button.disabled = true; break;
                case 'downloaded': button.innerHTML = '<i class="bi bi-cloud-check-fill"></i>'; button.classList.add('downloaded'); button.title = 'Descargado'; button.disabled = true; break;
                default: button.innerHTML = '<i class="bi bi-cloud-arrow-down"></i>'; button.title = 'Descargar para escuchar sin conexión'; break;
            }
        });
    }
    function updateAllDownloadButtons() {
        document.querySelectorAll('.download-btn').forEach(button => {
            const songId = button.dataset.songId;
            if (downloadedSongs.has(songId)) { updateDownloadButtonStatus(songId, 'downloaded'); } 
            else { updateDownloadButtonStatus(songId, 'not-downloaded'); }
        });
    }
    async function handleDownloadSkinsClick() {
        if (!navigator.serviceWorker.controller) { alert('El controlador de la aplicación no está listo. Por favor, recarga la página.'); return; }
        downloadSkinsBtn.disabled = true;
        downloadSkinsBtn.innerHTML = '<span class="spinner"></span> Guardando...';
        try {
            const response = await fetch(`${skinsPath}skins.json`);
            if (!response.ok) throw new Error('No se pudo obtener la lista de skins.');
            const skinFiles = await response.json();
            navigator.serviceWorker.controller.postMessage({ action: 'DOWNLOAD_SKIN_LIST', url: `${skinsPath}skins.json` });
            skinFiles.forEach(file => {
                navigator.serviceWorker.controller.postMessage({ action: 'DOWNLOAD_SKIN', url: `${skinsPath}${file}` });
            });
            const totalDownloads = skinFiles.length + 1;
            let downloadedCount = 0;
            const skinDownloadListener = (event) => {
                const action = event.data.action;
                if (action === 'SKIN_DOWNLOADED' || action === 'SKIN_LIST_DOWNLOADED' || action === 'SKIN_DOWNLOAD_ERROR') {
                    downloadedCount++;
                    downloadSkinsBtn.innerHTML = `<span class="spinner"></span> Guardando ${downloadedCount}/${totalDownloads}`;
                    if (downloadedCount === totalDownloads) {
                        navigator.serviceWorker.removeEventListener('message', skinDownloadListener);
                        downloadSkinsBtn.innerHTML = '<i class="bi bi-check-circle-fill"></i> Skins Guardados';
                        localStorage.setItem('kaylum_skins_downloaded', 'true');
                        alert('¡Skins guardados! Ahora puedes cambiarlos sin conexión.');
                        loadSkins();
                    }
                }
            };
            navigator.serviceWorker.addEventListener('message', skinDownloadListener);
        } catch (error) {
            console.error('Error al descargar skins:', error);
            downloadSkinsBtn.innerHTML = '<i class="bi bi-x-circle"></i> Error';
            downloadSkinsBtn.disabled = false;
        }
    }

    // --- PWA y Service Worker ---
    function setupServiceWorker() {
        if (!('serviceWorker' in navigator)) return;
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/kaylum/sw.js', { scope: '/kaylum/' }).then(registration => {
                console.log('Service Worker registrado con éxito:', registration.scope);
                navigator.serviceWorker.ready.then(readyReg => {
                    if (readyReg.active) { readyReg.active.postMessage({ action: 'GET_DOWNLOADED_SONGS' }); }
                });
            }).catch(err => { console.error('Fallo en el registro del SW:', err); });
        });
        navigator.serviceWorker.addEventListener('message', event => {
            if (!event.data) return;
            const { action, songId, songIds } = event.data;
            switch(action) {
                case 'SONG_DOWNLOADED':
                    downloadedSongs.add(songId);
                    updateDownloadButtonStatus(songId, 'downloaded');
                    if (downloadedSongs.size === 1) { playlistsData['Guardados'] = []; renderCategoryTabs(); }
                    break;
                case 'DOWNLOAD_ERROR': updateDownloadButtonStatus(songId, 'error'); alert(`No se pudo descargar la canción.`); break;
                case 'DOWNLOADED_SONGS_LIST':
                    downloadedSongs = new Set(songIds);
                    if (downloadedSongs.size > 0) { playlistsData['Guardados'] = []; }
                    if (allSongs.length > 0) { renderCategoryTabs(); }
                    break;
            }
        });
    }
    // **** CÓDIGO RESTAURADO ****
    function setupPWAInstall() {
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredInstallPrompt = e;
            if (addToHomeBtn) {
                console.log('PWA: Lista para instalar. Mostrando botón.');
                addToHomeBtn.style.display = 'inline-flex';
            }
        });

        if(addToHomeBtn) {
            addToHomeBtn.addEventListener('click', async () => {
                if (!deferredInstallPrompt) return;
                deferredInstallPrompt.prompt();
                await deferredInstallPrompt.userChoice;
                deferredInstallPrompt = null;
                addToHomeBtn.style.display = 'none';
            });
        }
    }
    
    // --- Lógica del reproductor y UI ---
    function loadSong(playlistIndex) { 
        if (playlistIndex < 0 || playlistIndex >= displayedPlaylist.length) return; 
        currentSongIndex = playlistIndex; 
        const song = displayedPlaylist[playlistIndex]; 
        songTitleEl.textContent = song.title; 
        songArtistEl.textContent = song.artist; 
        albumArtEl.src = (song.cover && song.cover.trim() !== '') ? song.cover : defaultCover; 
        songInformationEl.classList.remove('is-open'); 
        if (song.information && song.information.trim() !== '') { songInformationEl.textContent = song.information; songInfoToggleBtn.style.display = 'block'; } else { songInfoToggleBtn.style.display = 'none'; } 
        updatePlaylistHighlight(); 
        updateFavoriteButton(); 
        audioPlayer.src = song.publicUrl; 
        audioPlayer.play().catch(e => {}); 
        if ('mediaSession' in navigator) { navigator.mediaSession.metadata = new MediaMetadata({ title: song.title, artist: song.artist, album: `KAYLUM: ${song.category}`, artwork: [{ src: albumArtEl.src, sizes: '250x250', type: 'image/jpeg' }] }); } 
    }
    function playNextSong() { if (displayedPlaylist.length === 0) return; currentSongIndex = (currentSongIndex + 1) % displayedPlaylist.length; loadSong(currentSongIndex); }
    function playPrevSong() { if (displayedPlaylist.length === 0) return; currentSongIndex = (currentSongIndex - 1 + displayedPlaylist.length) % displayedPlaylist.length; loadSong(currentSongIndex); }
    function handleSongEnd() { if (isRepeatActive) { audioPlayer.currentTime = 0; audioPlayer.play(); } else { playNextSong(); } }
    function togglePlayPause() { if (audioPlayer.paused) { audioPlayer.play().catch(e => console.error("Error al reproducir:", e)); } else { audioPlayer.pause(); } }
    
    function toggleShuffle() {
        isShuffleActive = !isShuffleActive;
        shuffleBtn.classList.toggle('active', isShuffleActive);
        const originalPlaylist = playlistsData[currentCategory] || [];
        currentPlaylist = isShuffleActive ? shuffleArray(originalPlaylist) : [...originalPlaylist];
        updatePaginatedView();
    }
    function toggleRepeat() { isRepeatActive = !isRepeatActive; repeatBtn.classList.toggle('active', isRepeatActive); }
    function shareSong() {
        if (currentSongIndex < 0) { alert("Selecciona una canción para compartir."); return; }
        const songId = displayedPlaylist[currentSongIndex].publicId;
        const shareUrl = `${window.location.origin}${window.location.pathname}?song=${songId}`;
        navigator.clipboard.writeText(shareUrl).then(() => { shareBtn.innerHTML = '<i class="bi bi-check-lg"></i>'; setTimeout(() => { shareBtn.innerHTML = '<i class="bi bi-share-fill"></i>'; }, 2000); }).catch(err => { console.error('Error al copiar: ', err); alert("No se pudo copiar."); });
    }

    function renderPlaylistView(playlistToRender) {
        if (!playlistToRender || playlistToRender.length === 0) {
            let message = searchInput.value.trim() ? 'No se encontraron resultados para tu búsqueda.' : 'No hay canciones en esta categoría.';
            if (currentCategory === 'Guardados') message = 'Descarga canciones para escucharlas aquí sin conexión.';
            if (currentCategory === 'Favoritos') message = 'Marca tus canciones favoritas con el corazón para verlas aquí.';
            playlistViewContainer.innerHTML = `<p style="text-align:center; padding: 20px 0; color:var(--secondary-text-color);">${message}</p>`;
            return;
        }
        playlistViewContainer.innerHTML = `<ol>${playlistToRender.map(song => `<li data-global-index="${allSongs.findIndex(s => s.publicId === song.publicId)}"><i class="bi bi-music-note-beamed icon"></i><div class="track-details"><div class="title">${song.title}</div><div class="artist">${song.artist}</div></div><button class="download-btn" data-song-id="${song.publicId}" data-song-url="${song.publicUrl}"><i class="bi bi-cloud-arrow-down"></i></button></li>`).join('')}</ol>`;
        updatePlaylistHighlight();
        updateAllDownloadButtons();
    }
    function renderCategoryTabs() {
        const categories = Object.keys(playlistsData);
        let buttonsHTML = '';
        if (downloadedSongs.size > 0) buttonsHTML += `<button data-category="Guardados"><i class="bi bi-cloud-check"></i> Guardados</button>`;
        if (userFavorites.length > 0) buttonsHTML += `<button data-category="Favoritos"><i class="bi bi-star"></i> Favoritos</button>`;
        categories.filter(c => c !== 'Favoritos' && c !== 'Guardados' && !c.startsWith('Artista:')).forEach(c => { buttonsHTML += `<button data-category="${c}">${c}</button>`; });
        categoryTabsContainer.innerHTML = buttonsHTML;
        document.querySelectorAll('.category-tabs button').forEach(btn => btn.classList.toggle('active', btn.dataset.category === currentCategory));
    }
    function loadCategory(category) {
        currentCategory = category;
        searchInput.value = '';
        if (category === 'Favoritos') { currentPlaylist = allSongs.filter(song => userFavorites.includes(song.publicId)); } 
        else if (category === 'Guardados') { currentPlaylist = allSongs.filter(song => downloadedSongs.has(song.publicId)); } 
        else { const categorySongs = playlistsData[category] || []; currentPlaylist = isShuffleActive ? shuffleArray(categorySongs) : [...categorySongs]; }
        currentSongIndex = -1;
        currentPage = 1;
        renderCategoryTabs();
        updatePaginatedView();
        if (currentPlaylist.length > 0) { loadSong(0); } 
        else {
            songTitleEl.textContent = "Sin canciones";
            songArtistEl.textContent = "Categoría vacía";
            if (category === "Guardados") { songTitleEl.textContent = "Modo sin conexión"; songArtistEl.textContent = "Aún no tienes canciones guardadas."; }
            if (category === "Favoritos") { songTitleEl.textContent = "Sin favoritos"; songArtistEl.textContent = "Añade canciones a tus favoritos."; }
            albumArtEl.src = defaultCover;
            audioPlayer.src = "";
            songInfoToggleBtn.style.display = 'none';
            updateFavoriteButton();
        }
    }
    function updatePlaylistHighlight() { 
        if (currentSongIndex < 0) { document.querySelectorAll('.playlist-view li').forEach(li => li.classList.remove('playing')); return; }
        const currentSong = displayedPlaylist[currentSongIndex]; 
        if (!currentSong) return; 
        const globalIndex = allSongs.findIndex(s => s.publicId === currentSong.publicId); 
        document.querySelectorAll('.playlist-view li').forEach(li => li.classList.toggle('playing', parseInt(li.dataset.globalIndex) === globalIndex)); 
    }
    function updateFavoriteButton() { if (currentSongIndex < 0) { addToFavoritesBtn.innerHTML = '<i class="bi bi-heart"></i>'; addToFavoritesBtn.classList.remove('is-favorite'); return; } const songId = displayedPlaylist[currentSongIndex].publicId; const isFavorite = userFavorites.includes(songId); addToFavoritesBtn.innerHTML = isFavorite ? '<i class="bi bi-heart-fill"></i>' : '<i class="bi bi-heart"></i>'; addToFavoritesBtn.classList.toggle('is-favorite', isFavorite); }
    function toggleFavorite() { if (currentSongIndex < 0) return; const songId = displayedPlaylist[currentSongIndex].publicId; const favIndex = userFavorites.indexOf(songId); if (favIndex > -1) { userFavorites.splice(favIndex, 1); } else { userFavorites.push(songId); } localStorage.setItem('kaylum_favorites', JSON.stringify(userFavorites)); const hadFavorites = playlistsData['Favoritos']; if (userFavorites.length > 0 && !hadFavorites) { playlistsData['Favoritos'] = []; renderCategoryTabs(); } else if (userFavorites.length === 0 && hadFavorites) { delete playlistsData['Favoritos']; if (currentCategory === 'Favoritos') loadCategory(Object.keys(playlistsData).find(k => k !== 'Favoritos') || 'Guardados'); else renderCategoryTabs(); } updateFavoriteButton(); }
    
    function updatePaginatedView() { 
        const searchTerm = searchInput.value.trim();
        if (searchTerm.length > 1) {
            displayedPlaylist = fuse.search(searchTerm).map(result => result.item);
            document.querySelectorAll('.category-tabs button').forEach(btn => btn.classList.remove('active'));
        } else {
            displayedPlaylist = currentPlaylist;
            document.querySelectorAll('.category-tabs button').forEach(btn => btn.classList.toggle('active', btn.dataset.category === currentCategory));
        }
        const paginatedSongs = displayedPlaylist.slice((currentPage - 1) * songsPerPage, currentPage * songsPerPage);
        renderPlaylistView(paginatedSongs);
        renderPaginationControls(displayedPlaylist.length);
        updatePlaylistHighlight();
    }
    
    function renderPaginationControls(totalItems) { const totalPages = Math.ceil(totalItems / songsPerPage); paginationControlsContainer.style.display = totalPages > 1 ? 'flex' : 'none'; if (totalPages <= 1) { paginationControlsContainer.innerHTML = ''; return; } let buttonsHTML = `<button data-page="prev" ${currentPage === 1 ? 'disabled' : ''}><</button>`; let startPage = Math.max(1, currentPage - 1); let endPage = Math.min(totalPages, currentPage + 1); if (currentPage === 1) endPage = Math.min(totalPages, 3); if (currentPage === totalPages) startPage = Math.max(1, totalPages - 2); for (let i = startPage; i <= endPage; i++) { buttonsHTML += `<button data-page="${i}" class="${i === currentPage ? 'active' : ''}">${i}</button>`; } buttonsHTML += `<button data-page="next" ${currentPage === totalPages ? 'disabled' : ''}>></button>`; paginationControlsContainer.innerHTML = buttonsHTML; }

    // --- Carga Inicial ---
    async function loadSkins() { 
        try { 
            const response = await fetch(`${skinsPath}skins.json`);
            if (!response.ok) throw new Error('No se encontró skins.json'); 
            const skinFiles = await response.json(); 
            skins = skinFiles.map(file => `${skinsPath}${file}`); 
            if (skins.length > 0) { 
                const savedSkinIndex = parseInt(localStorage.getItem('kaylum_skinIndex'), 10);
                currentSkinIndex = (!isNaN(savedSkinIndex) && savedSkinIndex < skins.length) ? savedSkinIndex : 0;
                const initialSkin = skins[currentSkinIndex]; 
                const extension = initialSkin.split('.').pop(); 
                if (['webm', 'mp4'].includes(extension)) { backgroundVideo.innerHTML = `<source src="${initialSkin}" type="video/${extension}">`; } 
                else { backgroundVideo.style.backgroundImage = `url('${initialSkin}')`; backgroundVideo.innerHTML = ''; } 
                backgroundVideo.load();
                backgroundVideo.play().catch(e => {}); 
            } 
        } catch (error) { 
            console.warn("No se pudo cargar la lista de skins (posiblemente offline y sin caché):", error.message);
            skins = [];
        } 
    }
    function loadUserSettings() { 
        const savedColor = localStorage.getItem('kaylum_textColor'); 
        if (savedColor) { colorPicker.value = savedColor; } 
        const savedFavorites = localStorage.getItem('kaylum_favorites'); 
        if (savedFavorites) { userFavorites = JSON.parse(savedFavorites); } 
        if (localStorage.getItem('kaylum_skins_downloaded') === 'true') {
            downloadSkinsBtn.innerHTML = '<i class="bi bi-check-circle-fill"></i> Skins Guardados';
            downloadSkinsBtn.disabled = true;
        }
    }
    async function init() {
        playlistViewContainer.innerHTML = `<p style="text-align:center; padding: 40px 0; color:var(--secondary-text-color); font-style: italic;">Cargando música... <span class="spinner"></span></p>`;
        loadUserSettings();
        await loadSkins();
        try {
            const response = await fetch(`${googleSheetCsvUrl}&_=${new Date().getTime()}`);
            if (!response.ok) throw new Error("Red no disponible");
            const csvText = await response.text();
            if(!csvText) throw new Error("CSV vacío.");
            const rows = csvText.trim().replace(/\r/g, '').split('\n').slice(1);
            allSongs = []; playlistsData = {};
            rows.forEach(row => {
                const [title, artist, category, publicId, cover, information] = parseCsvRow(row);
                if (!category || !publicId || !title) return;
                const songObject = { title, artist, category, publicId, cover, information, publicUrl: `${cloudinaryBaseUrl}${publicId}` };
                if (!playlistsData[category]) playlistsData[category] = [];
                playlistsData[category].push(songObject);
                allSongs.push(songObject);
            });
            if (allSongs.length === 0) throw new Error("No se parsearon canciones.");
        } catch (error) {
            console.warn("MODO OFFLINE activado. Error:", error.message);
            playlistViewContainer.innerHTML = `<p style="text-align:center; padding: 40px 0; color:var(--secondary-text-color); font-style: italic;">Leyendo tus archivos guardados... <span class="spinner"></span></p>`;
            const savedMetadata = getDownloadedSongMetadata();
            allSongs = Object.values(savedMetadata);
            if (allSongs.length > 0) {
                allSongs.forEach(song => {
                    if (!playlistsData[song.category]) playlistsData[song.category] = [];
                    playlistsData[song.category].push(song);
                });
            }
        }
        fuse = new Fuse(allSongs, { keys: ['title', 'artist', 'information'], threshold: 0.4, minMatchCharLength: 2 });
        if (userFavorites.length > 0) playlistsData['Favoritos'] = [];
        if (downloadedSongs.size > 0) playlistsData['Guardados'] = [];
        renderCategoryTabs();
        if (allSongs.length > 0) {
            const urlParams = new URLSearchParams(window.location.search);
            const songIdFromUrl = urlParams.get('song');
            if (songIdFromUrl && allSongs.some(s => s.publicId === songIdFromUrl)) {
                 const songToPlay = allSongs.find(s => s.publicId === songIdFromUrl);
                 loadCategory(songToPlay.category);
                 loadSong(currentPlaylist.findIndex(s => s.publicId === songIdFromUrl));
            } else {
                const firstOnlineCat = Object.keys(playlistsData).find(k => !['Favoritos', 'Guardados'].includes(k) && !k.startsWith('Artista:'));
                const defaultCategory = !navigator.onLine && downloadedSongs.size > 0 ? 'Guardados' : firstOnlineCat || 'Guardados';
                loadCategory(defaultCategory);
            }
        } else {
            songTitleEl.textContent = "Sin Conexión";
            songArtistEl.textContent = "Conéctate para descubrir música.";
            playlistViewContainer.innerHTML = `<p style="text-align:center; padding: 20px 0; color:var(--secondary-text-color);">No hay canciones guardadas. Conéctate a internet para descargar música y skins.</p>`;
        }
        setupEventListeners();
    }
    function setupEventListeners() {
        audioPlayer.addEventListener('ended', handleSongEnd);
        playlistViewContainer.addEventListener('click', (e) => {
            const targetLi = e.target.closest('li');
            const downloadBtn = e.target.closest('.download-btn');
            if (downloadBtn) { e.stopPropagation(); handleDownloadClick(downloadBtn); return; }
            if (targetLi) {
                const clickedSong = allSongs[parseInt(targetLi.dataset.globalIndex)];
                if (clickedSong) loadSong(displayedPlaylist.findIndex(s => s.publicId === clickedSong.publicId));
            }
        });
        songArtistEl.addEventListener('click', () => {
            const artistName = songArtistEl.textContent;
            if (!artistName || artistName === 'para comenzar') return;
            const artistSongs = allSongs.filter(song => song.artist === artistName);
            if (artistSongs.length > 0) {
                const artistCatName = `Artista: ${artistName}`;
                playlistsData[artistCatName] = artistSongs;
                renderCategoryTabs();
                loadCategory(artistCatName);
            }
        });
        categoryTabsContainer.addEventListener('click', (e) => { const btn = e.target.closest('button'); if (btn) loadCategory(btn.dataset.category) });
        
        paginationControlsContainer.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button || button.disabled) return;
            const pageAction = button.dataset.page;
            if (pageAction === 'prev') currentPage--;
            else if (pageAction === 'next') currentPage++;
            else currentPage = parseInt(pageAction);
            updatePaginatedView();
        });
        prevBtn.addEventListener('click', playPrevSong);
        nextBtn.addEventListener('click', playNextSong);
        shuffleBtn.addEventListener('click', toggleShuffle);
        repeatBtn.addEventListener('click', toggleRepeat);
        shareBtn.addEventListener('click', shareSong);
        addToFavoritesBtn.addEventListener('click', toggleFavorite);
        searchInput.addEventListener('input', () => { currentPage = 1; updatePaginatedView(); });
        aboutToggleBtn.addEventListener('click', () => aboutContent.classList.toggle('is-open'));
        songInfoToggleBtn.addEventListener('click', () => songInformationEl.classList.toggle('is-open'));
        adventureModeBtn.addEventListener('click', () => {
            if (allSongs.length === 0) return;
            playlistsData['Aventura Musical'] = shuffleArray(allSongs);
            renderCategoryTabs();
            loadCategory('Aventura Musical');
        });
        changeSkinBtn.addEventListener('click', () => {
            if (skins.length === 0) {
                const message = navigator.onLine ? "No hay skins disponibles. Presiona 'Guardar Skins' primero." : "No hay skins guardados para usar sin conexión. Conéctate a internet y guárdalos.";
                alert(message);
                return;
            }
            currentSkinIndex = (currentSkinIndex + 1) % skins.length;
            localStorage.setItem('kaylum_skinIndex', currentSkinIndex);
            const newSkinSrc = skins[currentSkinIndex];
            const extension = newSkinSrc.split('.').pop().toLowerCase();
            backgroundVideo.style.opacity = 0;
            setTimeout(() => {
                if (['webm', 'mp4'].includes(extension)) {
                    backgroundVideo.style.backgroundImage = 'none';
                    backgroundVideo.innerHTML = `<source src="${newSkinSrc}" type="video/${extension}">`;
                    backgroundVideo.load();
                    backgroundVideo.play().catch(e => {});
                } else {
                    backgroundVideo.innerHTML = '';
                    backgroundVideo.style.backgroundImage = `url('${newSkinSrc}')`;
                }
                backgroundVideo.style.opacity = 1;
            }, 500);
        });
        colorPicker.addEventListener('input', (e) => { document.documentElement.style.setProperty('--text-color', e.target.value); localStorage.setItem('kaylum_textColor', e.target.value); });
        document.addEventListener('keydown', (e) => { if (document.activeElement !== searchInput && e.code === 'Space') { e.preventDefault(); togglePlayPause(); } });
        if ('mediaSession' in navigator) {
            navigator.mediaSession.setActionHandler('play', () => audioPlayer.play());
            navigator.mediaSession.setActionHandler('pause', () => audioPlayer.pause());
            navigator.mediaSession.setActionHandler('previoustrack', playPrevSong);
            navigator.mediaSession.setActionHandler('nexttrack', playNextSong);
        }
        downloadSkinsBtn.addEventListener('click', handleDownloadSkinsClick);
    }
    
    // 3. EJECUCIÓN INICIAL
    setupServiceWorker();
    setupPWAInstall(); // **** LLAMADA RESTAURADA ****
    init();

});
</script>
</body>
</html>
